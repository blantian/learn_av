# 一、概述
H.264，又称为 MPEG-4 Part 10 或 Advanced Video Coding（AVC），是由国际电信联盟（ITU-T）的视频编码专家组（VCEG）和国际标准化组织/国际电工委员会联合技术委员会（ISO/IEC JTC1）的运动图像专家组（MPEG）共同开发的高效视频编码标准。它于 2003 年正式发布，旨在以较低的比特率提供高质量的视频，从而提高视频的传输和存储效率。

# 二、发展背景
随着数字媒体的快速发展和高清晰度视频需求的增长，传统的视频编码标准（如 MPEG-2 和 H.263）已经难以满足日益增长的带宽和质量要求。为了在有限的带宽条件下传输高质量视频，业界需要一种更高效的编码标准。H.264 的诞生正是为了满足这一需求。

# 三、技术特点

## 1. 高压缩效率：
### 先进的预测技术：
H.264 引入了帧内（Intra）和帧间（Inter）预测，更细粒度的块划分（从 16x16 到 4x4）以及多参考帧预测，提高了预测精度。
### 自适应二进制算术编码（CABAC）和上下文自适应可变长编码（CAVLC）：
这两种熵编码方法提高了编码效率，其中 CABAC 可进一步降低约 10% 的比特率。
### 去块效应滤波器：
内置的去块滤波器可以减少块效应，提升视觉质量。
## 2. 网络友好的结构：
### 网络抽象层（NAL）：
将编码数据封装成 NAL 单元，以适应各种传输介质，如 IP 网络、无线网络和广播网络。
### 视频编码层（VCL）：
负责实际的视频数据编码，以生成高效的比特流。
## 3. 灵活性和可扩展性：
### 多种配置文件（Profiles）和级别（Levels）：
H.264 提供了 Baseline、Main、Extended、High 等多个配置文件，以满足不同应用的需求，如视频会议、广播和存储。
#### profile: 
规定了一个算法特征和限制的子集，任何遵守某个 profile 的解码器都应该支持与其相应的子集，是对视频压缩特性的描述（CABAC、颜色采样数等）
##### baseline profile (BP)：
基本画质。支持 I/P 帧，只支持无交错（Progressive）和 CAVLC
##### extended profile （EP）：
进阶画质。支持 I/P/B/SP/SI 帧，只支持无交错（Progressive）和 CAVLC；(用的少)
##### main profile （MP）：
主流画质。提供 I/P/B 帧，支持无交错（Progressive）和交错（Interlaced），也支持 CAVLC 和 CABAC 的支持
##### high profile （HP）：
高级画质。在 main profile 的基础上增加了 8x8 内部预测、自定义量化、无损视频编码和更多的 YUV 格式
#### level: 
规定了一组对标准中语法成员（syntax element）所采用的各种参数值的限制，对视频本身特性的描述 (fps (帧率)、码率、分辨率)

#####  第1部分：H.264 Profiles 详细对比

H.264 标准定义了多个 Profiles，每个 Profile 支持不同的编码特性。以下表格详细列出了各 Profile 支持的功能：

| 功能 | Baseline | Extended | Main | High | High 10 | High 4:2:2 | High 4:4:4 Predictive |
|------|----------|----------|------|------|---------|------------|----------------------|
| I and P Slices | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| B Slices | No | Yes | Yes | Yes | Yes | Yes | Yes |
| SI and SP Slices | No | Yes | No | No | No | No | No |
| Multiple Reference Frames | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| In-Loop Deblocking Filter | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| CAVLC Entropy Coding | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| CABAC Entropy Coding | No | No | Yes | Yes | Yes | Yes | Yes |
| Flexible Macroblock Ordering (FMO) | Yes | Yes | No | No | No | No | No |
| Arbitrary Slice Ordering (ASO) | Yes | Yes | No | No | No | No | No |
| Redundant Slices (RS) | Yes | Yes | No | No | No | No | No |
| Data Partitioning | No | Yes | No | No | No | No | No |
| Interlaced Coding (PicAFF, MBAFF) | No | Yes | Yes | Yes | Yes | Yes | Yes |
| 4:2:0 Chroma Format | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| Monochrome Video Format (4:0:0) | No | No | No | Yes | Yes | Yes | Yes |
| 4:2:2 Chroma Format | No | No | No | No | No | Yes | Yes |
| 4:4:4 Chroma Format | No | No | No | No | No | No | Yes |
| 8 Bit Sample Depth | Yes | Yes | Yes | Yes | Yes | Yes | Yes |
| 9 and 10 Bit Sample Depth | No | No | No | No | Yes | Yes | Yes |
| 11 to 14 Bit Sample Depth | No | No | No | No | No | No | Yes |
| 8×8 vs. 4×4 Transform Adaptivity | No | No | No | Yes | Yes | Yes | Yes |
| Quantization Scaling Matrices | No | No | No | Yes | Yes | Yes | Yes |
| Separate Cb and Cr QP control | No | No | No | Yes | Yes | Yes | Yes |
| Separate Color Plane Coding | No | No | No | No | No | No | Yes |
| Predictive Lossless Coding | No | No | No | No | No | No | Yes |

##### 第2部分：H.264 Levels 详细参数表

H.264 标准定义了多个 Levels，每个 Level 规定了视频编码的特定限制。以下表格详细列出了各 Level 的参数：

| Level | Max macroblocks per second | Max frame size (macroblocks) | Max video bit rate (VCL) for Baseline, Extended and Main Profiles | Max video bit rate (VCL) for High Profile | Max video bit rate (VCL) for High 10 Profile | Max video bit rate (VCL) for High 4:2:2 and High 4:4:4 Predictive Profiles | Examples for high resolution @ frame rate (max stored frames) |
|-------|----------------------------|------------------------------|-------------------------------------------------------------------|-------------------------------------------|----------------------------------------------|----------------------------------------------------------------------------|----------------------------------------------------------------|
| 1 | 1,485 | 99 | 64 kbit/s | 80 kbit/s | 192 kbit/s | 256 kbit/s | 128×96@30.9 (8), 176×144@15.0 (4) |
| 1b | 1,485 | 99 | 128 kbit/s | 160 kbit/s | 384 kbit/s | 512 kbit/s | 128×96@30.9 (8), 176×144@15.0 (4) |
| 1.1 | 3,000 | 396 | 192 kbit/s | 240 kbit/s | 576 kbit/s | 768 kbit/s | 176×144@30.3 (9), 352×288@7.5 (2) |
| 1.2 | 6,000 | 396 | 384 kbit/s | 480 kbit/s | 1,152 kbit/s | 1,536 kbit/s | 320×240@20.0 (7), 352×288@15.2 (6) |
| 1.3 | 11,880 | 396 | 768 kbit/s | 960 kbit/s | 2,304 kbit/s | 3,072 kbit/s | 320×240@36.0 (7), 352×288@30.0 (6) |
| 2 | 11,880 | 396 | 2 Mbit/s | 2.5 Mbit/s | 6 Mbit/s | 8 Mbit/s | 320×240@36.0 (7), 352×288@30.0 (6) |
| 2.1 | 19,800 | 792 | 4 Mbit/s | 5 Mbit/s | 12 Mbit/s | 16 Mbit/s | 352×480@30.0 (7), 352×576@25.0 (6) |
| 2.2 | 20,250 | 1,620 | 4 Mbit/s | 5 Mbit/s | 12 Mbit/s | 16 Mbit/s | 352×480@30.7 (10), 720×480@15.0 (6) |
| 3 | 40,500 | 1,620 | 10 Mbit/s | 12.5 Mbit/s | 30 Mbit/s | 40 Mbit/s | 720×480@30.0 (6), 720×576@25.0 (5) |
| 3.1 | 108,000 | 3,600 | 14 Mbit/s | 17.5 Mbit/s | 42 Mbit/s | 56 Mbit/s | 1280×720@30.0 (5), 720×576@66.7 (11) |
| 3.2 | 216,000 | 5,120 | 20 Mbit/s | 25 Mbit/s | 60 Mbit/s | 80 Mbit/s | 1280×720@60.0 (5), 1280×1024@42.2 (4) |
| 4 | 245,760 | 8,192 | 20 Mbit/s | 25 Mbit/s | 60 Mbit/s | 80 Mbit/s | 1920×1088@30.1 (4), 2048×1024@30.0 (4) |
| 4.1 | 245,760 | 8,192 | 50 Mbit/s | 50 Mbit/s | 150 Mbit/s | 200 Mbit/s | 1920×1088@30.1 (4), 2048×1024@30.0 (4) |
| 4.2 | 522,240 | 8,704 | 50 Mbit/s | 50 Mbit/s | 150 Mbit/s | 200 Mbit/s | 1920×1088@64.0 (4), 2048×1088@60.0 (4) |
| 5 | 589,824 | 22,080 | 135 Mbit/s | 168.75 Mbit/s | 405 Mbit/s | 540 Mbit/s | 1920×1088@72.3 (13), 3680×1536@26.7 (5) |
| 5.1 | 983,040 | 36,864 | 240 Mbit/s | 300 Mbit/s | 720 Mbit/s | 960 Mbit/s | 1920×1088@120.5 (16), 4096×2304@26.7 (5) |

##### 第3部分：Profiles 和 Levels 的应用场景分析

1. **Baseline Profile**
   - 主要用途：视频通话、移动应用
   - 特点：低复杂度，适合实时通信和资源受限设备
   - 推荐 Levels：1 到 3，取决于具体应用需求

2. **Extended Profile**
   - 主要用途：流媒体视频
   - 特点：具有数据分区功能，适合网络传输
   - 推荐 Levels：3 到 4，以支持较高的比特率和分辨率

3. **Main Profile**
   - 主要用途：广播和存储应用
   - 特点：平衡了编码效率和复杂度
   - 推荐 Levels：3 到 4.1，适用于标清到高清视频

4. **High Profile**
   - 主要用途：高清广播、Blu-ray 光盘
   - 特点：高编码效率，支持更高的比特深度
   - 推荐 Levels：4 到 5.1，支持高分辨率和高帧率

5. **High 10 Profile**
   - 主要用途：专业视频制作、高端消费电子
   - 特点：支持 10 位采样深度，提供更好的色彩精度
   - 推荐 Levels：4.1 到 5.1，适用于高品质视频制作

6. **High 4:2:2 Profile**
   - 主要用途：专业视频制作、广播级应用
   - 特点：支持 4:2:2 色度采样，提供更高的色彩精度
   - 推荐 Levels：4.1 到 5.1，适用于高端视频制作和传输

7. **High 4:4:4 Predictive Profile**
   - 主要用途：高端专业视频制作、数字电影
   - 特点：支持 4:4:4 色度采样和更高的比特深度，可进行无损编码
   - 推荐 Levels：4.1 到 5.1，适用于最高质量的视频制作
##### **那么如何计算level 呢？**
 这里简单举个例子：
1920x1080p视频属于哪个H.264/AVC level，我们需要考虑几个关键因素：
##### 1. 分辨率
##### 2. 帧率
##### 3. 比特率
对于1920x1080p的视频：
##### 分辨率计算：
#####  1920x1080 = 2,073,600像素
#####  以16x16像素的宏块计算：(1920/16) * (1080/16) = 120 * 68 = 8,160宏块
##### 帧率：
假设是常见的30fps（帧/秒）
##### 宏块处理速率：
  **8,160 * 30 = 244,800 宏块/秒**
##### 根据这些信息，我们可以查看level表：
#####  Level 4.0 支持最大245,760宏块/秒，最大帧大小8,192宏块
#####  Level 4.1 支持最大245,760宏块/秒，最大帧大小8,192宏块，但允许更高的比特率（50,000 kbit/s vs 20,000 kbit/s）
因此，1920x1080p@30fps的视频至少需要Level 4.1。
如果帧率更高（如60fps），或者比特率超过20,000 kbit/s，那么可能需要更高的level。
具体来说：
对于1920x1080p@30fps，通常使用Level 4.1
对于1920x1080p@60fps，通常使用Level 4.2或更高
实际使用时，编码器会根据具体的编码参数（如比特率、使用的编码工具等）选择合适的level。如果你在编码时指定了特定的level，那么编码器会确保编码参数不会超过该level的限制。
#### 细心的朋友会发现，在计算过程中并没有使用到比特率，那么比特率有啥用？
##### 比特率（Bitrate）是什么：
比特率是指在单位时间内传输或处理的比特（二进制数字）数量。在视频编码中，它表示每秒钟传输的数据量。
单位通常是 bits per second (bps)，常见的还有 kbps（千比特每秒）或 Mbps（兆比特每秒）
例如，10 Mbps 意味着每秒传输 10 百万比特的数据
比特率在 H.264/AVC levels 中的作用：

虽然在初步估算 level 时我们主要考虑了分辨率和帧率，但比特率确实是 level 规范中的一个重要参数。

每个 level 都规定了最大比特率限制。例如：

##### Level 4.0 的最大比特率为 20,000 kbps
##### Level 4.1 的最大比特率为 50,000 kbps
比特率限制确保了解码器能够及时处理incoming数据流。

##### 如何考虑比特率：

首先根据分辨率和帧率确定最低所需的 level。

然后检查实际使用的比特率是否超过了该 level 的限制。如果超过，就需要选择更高的 level。

例如，对于我们之前讨论的1920x1080p@30fps的视频：

  **1. 如果比特率低于20 Mbps，Level 4.0可能足够**
  
  **2. 如果比特率在20-50 Mbps之间，则需要Level 4.1**
  
  **3. 如果比特率超过50 Mbps，可能需要更高的level**
  
##### 实际应用：
在实际编码过程中，编码器会综合考虑所有这些因素（分辨率、帧率、比特率等）来选择适当的level。如果您在编码时指定了目标比特率，编码器会确保选择的level能够支持该比特率。
虽然比特率不是计算所需level的唯一因素，但它是一个重要的限制条件。在确定视频的H.264/AVC level时，需要同时考虑分辨率、帧率和比特率这三个主要因素。
#### 结论

1. H.264 标准通过多样化的 Profiles 和 Levels，为不同应用场景提供了灵活的编码选项。
2. 低级 Profiles（如 Baseline）和低 Levels 适用于资源受限的设备和实时通信应用。
3. 高级 Profiles（如 High 4:4:4 Predictive）和高 Levels 支持专业级视频制作和高质量广播。
4. 选择合适的 Profile 和 Level 组合对于优化视频质量、压缩效率和设备兼容性至关重要。
5. 随着技术进步，高级 Profiles 和更高 Levels 的应用正变得越来越普遍，特别是在高清和超高清视频领域。
6. 
### 支持多视角和可伸缩视频编码：
虽然主要在后续的扩展中引入，但 H.264 的框架为这些功能的实现奠定了基础。
# 四、主要应用

## 1. 视频广播和存储：

### 高清电视（HDTV）和超高清电视（UHDTV）：
H.264 被广泛应用于数字电视广播和蓝光光盘中。
### 视频点播（VOD）和流媒体服务：
如 Netflix、YouTube 等大量采用 H.264 进行视频压缩。
## 2. 视频通信：

### 视频会议和视频通话：
由于其高压缩效率和低延迟特性，H.264 被广泛应用于实时通信应用，如 Zoom、Skype 等。
## 3. 移动和互联网视频：

### 移动设备：
智能手机、平板电脑等设备采用 H.264 进行视频录制和播放。
### 网络视频：
H.264 是网页视频的主流格式，兼容性强，性能稳定。
## 4. 监控和安全：
数字视频监控系统（DVR/NVR）：在安防行业，H.264 被用于压缩监控视频，以节省存储空间和带宽。
# 五、优势分析

## 1. 高效性：
相比之前的标准，在相同图像质量下，H.264 可将比特率降低约 50%。
## 2. 兼容性强：
由于其广泛的应用和支持，H.264 已成为行业标准，设备兼容性好。
## 3. 灵活性：
多种配置文件和级别使其适用于从低带宽到高质量的各种应用场景。
# 六、后续标准
虽然 H.264 取得了巨大的成功，但随着超高清视频和 8K 视频的兴起，对更高压缩效率的需求推动了新标准的研发。

## 1. H.265/HEVC（高效视频编码）：
于 2013 年发布，相比 H.264，在相同图像质量下，比特率可降低约 50%。
支持更高的分辨率：如 4K 和 8K 视频。
## 2. H.266/VVC（可变视频编码）：
于 2020 年发布，进一步提升压缩效率，比 H.265 再降低约 50% 的比特率。
针对新应用优化：如 360 度全景视频、VR 和 AR 应用。
# 七、总结

H.264 作为一项革命性的视频编码标准，极大地推动了数字视频行业的发展。其高效的压缩能力和广泛的应用领域，使其在过去的二十年中一直保持着重要地位。尽管新一代的编码标准正在兴起，但由于兼容性和成熟的生态系统，H.264 仍将在相当长的时间内被广泛使用。


# 预测技术详解
## 一、视频编码中的预测编码概述
在视频编码中，预测编码是一种通过预测视频帧中的像素值来减少数据量的方法。其基本思想是利用视频帧内或帧间的冗余，减少需要传输或存储的数据量。

### 空间冗余：同一帧内相邻像素之间的相关性。
### 时间冗余：相邻帧间像素的相关性。
H.264 充分利用了这两种冗余，通过帧内和帧间预测提高压缩效率。

## 二、帧内（Intra）预测
### 1. 定义
帧内预测是指在同一帧内利用空间相关性进行预测。也就是说，使用当前帧中已经编码的相邻像素块来预测当前块的像素值。

### 2. 细粒度的块划分
H.264 将图像分成多个宏块（Macroblock），每个宏块的大小为 16x16 像素。为了提高帧内预测的精度，H.264 允许将宏块进一步划分为更小的子块，包括：
16x16
8x8
4x4
### 3. 帧内预测模式
对于不同大小的块，H.264 定义了多种预测模式：
#### 4x4 块：
有 9 种预测模式，包括垂直、水平、对角线等不同方向的预测。
#### 8x8 块（在高配置文件中引入）：
有 9 种预测模式，类似于 4x4 块。
#### 16x16 块：
有 4 种预测模式，包括 DC（平均值）、垂直、水平和平面预测。
### 4. 工作原理
#### 预测步骤：
对于当前块，使用其左边和上边已编码块的像素值。
根据选择的预测模式，计算当前块的预测值。
#### 残差计算：
将预测值与当前块的真实像素值相减，得到残差。
仅对残差进行编码，有效减少了数据量。
### 5. 细粒度块划分的意义
#### 提高预测精度：
小块能够更精确地适应图像的局部特性，特别是在边缘和细节丰富的区域。
#### 自适应性强：
编码器可以根据图像内容，选择最合适的块大小和预测模式，达到最佳的压缩效率。
## 三、帧间（Inter）预测
### 1. 定义
帧间预测利用时间上的冗余，即利用前一帧或多帧中的信息来预测当前帧。通常通过运动估计和运动补偿来实现。

### 2. 细粒度的块划分
为了更精确地描述运动，H.264 允许将宏块划分为更小的块，包括：
####  16x16
####  16x8
####  8x16
####  8x8
其中，8x8 块可以进一步划分为：
#### 8x8
#### 8x4
#### 4x8
#### 4x4
### 3. 运动估计和运动补偿
#### 运动估计：
在参考帧中寻找与当前块最匹配的区域。
计算运动向量（Motion Vector），表示块的位移。
#### 运动补偿：
使用运动向量对参考帧进行位移，预测当前块的像素值。
### 4. 工作原理
#### 预测步骤：
将当前块与参考帧中的候选块进行比较，找到最佳匹配。
使用最佳匹配块的像素值作为预测值。
#### 残差计算：
计算当前块与预测值的残差。
仅编码残差和运动向量，减少数据量。
### 5. 细粒度块划分的意义
#### 精细运动描述：
小块能够更准确地捕获复杂的运动，例如物体的形变、旋转等。
#### 提高预测精度：
更小的块尺寸可以减少预测误差，从而降低残差能量，提高压缩效率。
## 四、为什么要从 16x16 到 4x4 的块划分
### 1. 图像和视频的复杂性
#### 平坦区域：
在颜色和亮度变化较小的区域，如天空、海洋等，大块（16x16）可以有效地进行预测。
#### 细节丰富区域：
在边缘、纹理复杂的区域，小块（4x4、8x8）可以更精确地捕获细节。
### 2. 运动的复杂性
#### 简单运动：
对于整体移动的场景，大块可以有效地描述运动。
#### 复杂运动：
对于局部运动、物体变形等情况，小块可以更准确地描述。
### 3. 编码效率和平衡
##### 预测精度 vs 编码开销：
小块提高预测精度，但增加了编码开销（需要传输更多的块信息和运动向量）。
大块降低了预测精度，但编码开销较小。
#### 自适应选择：
编码器根据图像内容，平衡预测精度和编码开销，选择最优的块大小。
## 五、举例说明
### 1. 静止场景
#### 特点：
场景中没有或很少运动。
#### 处理方式：
使用较大的块（如 16x16）进行帧间预测，减少运动向量的数量，降低编码开销。
### 2. 复杂运动场景
#### 特点：
场景中有快速移动的物体、复杂的细节变化。
#### 处理方式：
将宏块划分为更小的块（如 8x8、4x4），进行精细的运动估计，提高预测精度，减少残差能量。
## 六、技术优势总结
### 高压缩效率：
细粒度的块划分和丰富的预测模式能够更准确地预测图像和视频内容，减少残差。
### 灵活性：
编码器可以根据内容自适应地选择块大小和预测模式，适应各种场景和应用需求。
### 图像质量：
提高预测精度，减少压缩引起的失真，提升图像和视频的主观质量。
## 七、与其他标准的比较
### 传统标准（如 MPEG-2）：
通常仅支持固定的块大小，预测精度较低。
压缩效率相对较低。
### H.264 的创新：
引入了更小的块划分（至 4x4），提高了预测的灵活性和精度。
支持多参考帧、丰富的预测模式等，提高了压缩效率。
## 八、总结
H.264 通过引入帧内和帧间预测的更细粒度块划分，从 16x16 到 4x4，大大提高了视频编码的压缩效率。细粒度的块划分允许编码器灵活地适应各种图像和视频内容，提高预测精度，减少残差能量，实现更高的压缩比和更好的图像质量。
### 这种技术的核心思想是：
#### 充分利用空间和时间冗余：
通过帧内预测捕获空间相关性，帧间预测捕获时间相关性。
#### 自适应编码：
根据内容选择最佳的块大小和预测模式，在压缩效率和计算复杂度之间取得平衡。
